# This file contains common pin mappings for the BIGTREETECH SKR V1.4
# board. To use this config, the firmware should be compiled for the
# LPC1768 or LPC1769(Turbo).

# See docs/Config_Reference.md for a description of parameters.

## Webclient config files. Uncomment one depending on UI being used.
[include mainsail.cfg]
#[include fluidd.cfg] 

[include timelapse.cfg]
[include stealthburner_leds.cfg]
[include backup.cfg]

[exclude_object]
[include KAMP_Settings.cfg]
[include macros.cfg]
[include menu.cfg]
[include splash.cfg]

[motor_constants 42BYGH47-401A]
resistance: 1.65
inductance: 0.0028
holding_torque: 0.54
max_current: 1.5
steps_per_revolution: 200

############################################################
# X Stepper Settings
############################################################

[stepper_x]
step_pin: P2.2
dir_pin: !P2.6
enable_pin: !P2.1
rotation_distance: 32
#full_steps_per_rotation: 200
microsteps: 16
endstop_pin: tmc2209_stepper_x:virtual_endstop #sensorless homing
# endstop_pin: P1.29
position_min: 0
position_endstop: 0
position_max: 250
homing_speed: 40
homing_retract_dist: 0
homing_positive_dir: false

[tmc2209 stepper_x]
uart_pin: P1.10
run_current: 0.8
diag_pin: ^P1.29
#driver_SGTHRS: 40
interpolate: true
stealthchop_threshold: 0

[autotune_tmc stepper_x]
motor: 42BYGH47-401A
tuning_goal: performance
sg4_thrs: 40

############################################################
# Y Stepper Settings
############################################################

[stepper_y]
step_pin: P0.19
dir_pin: P0.20
enable_pin: !P2.8
rotation_distance: 32
#full_steps_per_rotation: 200
microsteps: 16
endstop_pin: tmc2209_stepper_y:virtual_endstop  #sensorless homing
# endstop_pin: P1.28
position_endstop: -25
position_min: -25
position_max: 250
homing_speed: 40
homing_retract_dist: 0
homing_positive_dir: false

[tmc2209 stepper_y]
uart_pin: P1.9
run_current: 0.8
diag_pin: ^P1.28
#driver_SGTHRS: 70
interpolate: true
stealthchop_threshold: 0

[autotune_tmc stepper_y]
motor: 42BYGH47-401A
tuning_goal: performance
sg4_thrs: 70

############################################################
# Z Stepper Settings
############################################################

[stepper_z]
step_pin: P0.22
dir_pin: !P2.11
enable_pin: !P0.21
rotation_distance: 32
#full_steps_per_rotation: 200
microsteps: 16
endstop_pin: probe:z_virtual_endstop
# endstop_pin: P1.27
position_max: 400
homing_speed: 40
position_min: -3

[tmc2209 stepper_z]
uart_pin: P1.8
run_current: 0.8
interpolate: true
stealthchop_threshold: 0

[autotune_tmc stepper_z]
motor: 42BYGH47-401A
tuning_goal: performance
sg4_thrs: 40

############################################################
# Extruder Stepper Settings
############################################################

[extruder]
step_pin: P2.13
dir_pin: P0.11
enable_pin: !P2.12
rotation_distance: 54.13379544  # Re-calibrate your own value
gear_ratio: 44:10, 37:17
microsteps: 16
full_steps_per_rotation: 200
nozzle_diameter: 0.400
filament_diameter: 1.750
heater_pin: P2.7
sensor_type: Generic 3950
sensor_pin: P0.24
#control: pid
#pid_Kp: 37.413
#pid_Ki: 3.837
#pid_Kd: 91.195
min_temp: 0
max_temp: 260
max_extrude_only_distance: 101.0
max_extrude_cross_section: 5
#min_extrude_temp: 0

[tmc2209 extruder]
uart_pin: P1.4
run_current: 0.650
interpolate: true

[autotune_tmc stepper_z]
motor: ldo-36sth20-1004ahg

[firmware_retraction]
retract_length: 0.4

############################################################
# Bed Settings
############################################################

[heater_bed]
heater_pin: P2.5
sensor_type: ATC Semitec 104GT-2
sensor_pin: P0.25
min_temp: -10
max_temp: 130
#control: pid
#pid_kp: 68.646
#pid_ki: 0.963
#pid_kd: 1222.764

############################################################
# Homing and Bed Leveling
############################################################
[include eddy.cfg]

[screws_tilt_adjust]
screw1: 25,0
screw1_name: front left screw
screw2: 225,0
screw2_name: front right screw
screw3: 225,210
screw3_name: rear right screw
screw4: 25,210
screw4_name: rear left screw
horizontal_move_z: 5
speed: 80
screw_thread: CW-M3

############################################################
# Mechanics and Electronics
############################################################

[printer]
kinematics: corexz
max_velocity: 200
max_accel: 2000
square_corner_velocity: 5.0
max_z_velocity: 100
max_z_accel: 1000

[mcu]
serial: /dev/serial/by-id/usb-Klipper_lpc1768_17E0FF0FC720FAAEE6B2D957C72000F5-if00
restart_method: command

[mcu host]
serial: /tmp/klipper_host_mcu

[fan]
pin: P2.4
off_below: 0.1

[heater_fan hotend_fan]
pin: P2.3
off_below: 0.1
heater: extruder

[filament_switch_sensor RunoutSensor]
pause_on_runout: True
runout_gcode: _warning_beep
switch_pin: !P1.0

[temperature_sensor raspberry_pi]
sensor_type: temperature_host
min_temp: 10
max_temp: 100

[idle_timeout]
gcode:
  {% if printer.pause_resume.is_paused %}
    SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=idle_state VALUE=True
    {action_respond_info("Idle Timeout: Extruder powered down")}
    M104 S0   ; Set Hot-end to 0C (off)
  {% else %}
    {action_respond_info("Idle Timeout: Stepper and Heater powered down")}
    TURN_OFF_HEATERS
    M84
  {% endif %}
    
########################################
# EXP1 / EXP2 (display) pins
########################################

[board_pins]
aliases:
    # EXP1 header
    EXP1_1=P1.30, EXP1_3=P1.18, EXP1_5=P1.20, EXP1_7=P1.22, EXP1_9=<GND>,
    EXP1_2=P0.28, EXP1_4=P1.19, EXP1_6=P1.21, EXP1_8=P1.23, EXP1_10=<5V>,
    # EXP2 header
    EXP2_1=P0.17, EXP2_3=P3.26, EXP2_5=P3.25, EXP2_7=P1.31, EXP2_9=<GND>,
    EXP2_2=P0.15, EXP2_4=P0.16, EXP2_6=P0.18, EXP2_8=<RST>, EXP2_10=<NC>
    # Pins EXP2_1, EXP2_6, EXP2_2 are also MISO, MOSI, SCK of bus "ssp0"

# See the sample-lcd.cfg file for definitions of common LCD displays.

######################################################################
# "RepRapDiscount 128x64 Full Graphic Smart Controller" type displays
######################################################################

[display]
lcd_type: st7920
cs_pin: EXP1_4
sclk_pin: EXP1_5
sid_pin: EXP1_3
encoder_pins: ^EXP2_3, ^EXP2_5
click_pin: ^!EXP1_2
#kill_pin: ^!EXP2_8

[output_pin beeper]
pin: EXP1_1

######################################################################
# MKS Mini 12864 LCD
######################################################################

# Make sure that the EXP1 and EXP2 are rotated correctly on the
# display board. The cutouts on the connectors should be towards the
# center of the PCB. See:
#   https://reprap.org/wiki/MKS_MINI_12864#Physical_Interface
# If they are wrong, the connector housing can be pried off carefully
# with a small screwdriver and relocated the correct way.

#[display]
#lcd_type: uc1701
#cs_pin: EXP1_6
#a0_pin: EXP1_7
#contrast: 40
#encoder_pins: ^EXP2_3, ^EXP2_5
#click_pin: ^!EXP1_2
## Some micro-controller boards may require an spi bus to be specified:
#spi_bus: spi
## Alternatively, some micro-controller boards may work with software spi:
#spi_software_miso_pin: EXP2_1
#spi_software_mosi_pin: EXP2_6
#spi_software_sclk_pin: EXP2_2

#[output_pin beeper]
#pin: EXP1_1

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 34.172
#*# pid_ki = 3.452
#*# pid_kd = 84.576
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 66.534
#*# pid_ki = 1.158
#*# pid_kd = 955.593
#*#
#*# [probe_eddy_current btt_eddy]
#*# reg_drive_current = 15
#*# calibrate =
#*# 	0.050000:3222161.082,0.090000:3222122.217,0.130000:3222065.215,
#*# 	0.170000:3222042.162,0.210000:3221996.414,0.250000:3221939.931,
#*# 	0.290000:3221894.771,0.330000:3221811.164,0.370000:3221650.785,
#*# 	0.410000:3221487.870,0.450000:3221333.806,0.490000:3221187.437,
#*# 	0.530000:3221017.569,0.570000:3220880.022,0.610000:3220728.927,
#*# 	0.650000:3220582.716,0.690000:3220447.848,0.730000:3220302.064,
#*# 	0.770000:3220173.978,0.810000:3220025.385,0.850000:3219885.201,
#*# 	0.890000:3219759.432,0.930000:3219652.977,0.970000:3219506.074,
#*# 	1.010000:3219365.537,1.050000:3219255.599,1.090000:3219122.009,
#*# 	1.130000:3218992.403,1.170000:3218865.361,1.210000:3218759.930,
#*# 	1.250000:3218639.567,1.290000:3218531.281,1.330000:3218406.536,
#*# 	1.370000:3218292.940,1.410000:3218186.997,1.450000:3218090.975,
#*# 	1.490000:3217963.241,1.530000:3217856.812,1.570000:3217719.432,
#*# 	1.610000:3217625.257,1.650000:3217538.908,1.690000:3217430.740,
#*# 	1.730000:3217339.531,1.770000:3217241.573,1.810000:3217148.921,
#*# 	1.850000:3217055.451,1.890000:3216968.663,1.930000:3216856.354,
#*# 	1.970000:3216785.415,2.010000:3216691.788,2.050000:3216576.413,
#*# 	2.090000:3216494.527,2.130000:3216410.934,2.170000:3216324.910,
#*# 	2.210000:3216240.747,2.250000:3216146.922,2.290000:3216070.093,
#*# 	2.330000:3216011.708,2.370000:3215892.370,2.410000:3215842.925,
#*# 	2.450000:3215745.680,2.490000:3215664.469,2.530000:3215590.045,
#*# 	2.570000:3215532.414,2.610000:3215454.138,2.650000:3215365.725,
#*# 	2.690000:3215284.877,2.730000:3215240.250,2.770000:3215155.806,
#*# 	2.810000:3215087.877,2.850000:3215007.645,2.890000:3214940.697,
#*# 	2.930000:3214884.523,2.970000:3214812.575,3.010000:3214757.561,
#*# 	3.050000:3214679.450,3.090000:3214620.903,3.130000:3214558.287,
#*# 	3.170000:3214486.720,3.210000:3214426.573,3.250000:3214347.864,
#*# 	3.290000:3214302.498,3.330000:3214252.498,3.370000:3214176.754,
#*# 	3.410000:3214140.097,3.450000:3214087.923,3.490000:3214016.151,
#*# 	3.530000:3213963.146,3.570000:3213918.684,3.610000:3213837.846,
#*# 	3.650000:3213803.231,3.690000:3213742.602,3.730000:3213677.316,
#*# 	3.770000:3213651.875,3.810000:3213581.981,3.850000:3213525.375,
#*# 	3.890000:3213487.249,3.930000:3213434.294,3.970000:3213392.082,
#*# 	4.010000:3213335.807,4.050000:3213279.608
#*#
#*# [temperature_probe btt_eddy]
#*# calibration_temp = 34.426022
#*# drift_calibration =
#*# 	3234568.008754, -565.303292, 5.295071
#*# 	3233941.775066, -609.015615, 5.911123
#*# 	3230423.279012, -521.125594, 4.950720
#*# 	3227507.477878, -447.449748, 4.110125
#*# 	3225412.510421, -404.127613, 3.648488
#*# 	3223442.665919, -357.352689, 3.127330
#*# 	3221251.690442, -291.878281, 2.380117
#*# 	3220487.861261, -289.041825, 2.353792
#*# 	3219013.997121, -249.383232, 1.912271
#*# drift_calibration_min_temp = 30.8028722154625
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	0.283753, 0.288279, 0.258666, 0.240757, 0.250019, 0.238263, 0.246764, 0.288505, 0.175280
#*# 	0.253753, 0.280711, 0.245136, 0.239153, 0.255697, 0.228499, 0.244128, 0.289001, 0.128700
#*# 	0.236475, 0.268717, 0.209638, 0.198851, 0.204831, 0.198069, 0.225101, 0.261727, 0.107929
#*# 	0.223974, 0.249582, 0.206423, 0.188356, 0.183045, 0.165080, 0.185161, 0.240739, 0.083414
#*# 	0.222319, 0.240736, 0.195796, 0.174393, 0.178087, 0.153994, 0.182274, 0.224536, 0.063761
#*# 	0.214350, 0.236842, 0.193781, 0.174688, 0.185059, 0.162003, 0.181364, 0.226386, 0.066493
#*# 	0.245491, 0.236292, 0.213837, 0.198809, 0.195959, 0.188175, 0.213773, 0.255657, 0.093471
#*# 	0.293385, 0.313430, 0.273233, 0.271235, 0.276963, 0.252110, 0.258139, 0.308733, 0.150802
#*# 	0.276219, 0.261934, 0.216981, 0.199635, 0.210118, 0.207139, 0.224736, 0.278604, 0.166058
#*# x_count = 9
#*# y_count = 9
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 15.0
#*# max_x = 235.0
#*# min_y = 21.42
#*# max_y = 234.94
